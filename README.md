### Домашнее задание к занятию «Резервное копирование баз данных» - Корольков Денис

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

Ответ:

1.1.	 Необходимо восстанавливать данные в полном объёме за предыдущий день.

Первый вариант.

Первое что будем делать – это выберем стратегию создания резервного копирования.
- Каждые выходные (воскресенье) у нас будет создаваться полный backup БД. Будем использовать эту копию как начальную точку.
- Каждый день, по вечеру, будем создавать incremental backup.
p.s. Храним backup на отдельном сервере/хранилище/DVD/HDD…
При необходимости восстановления БД, например, за среду:
- сначала восстанавливаем full backup с ближайших выходных(воскресенья),
- далее на восстановленную БД заливаем incremental backup за понедельник,
- заливаем поверх incremental backup за вторник.
Готово. 
Узкое место данного способа восстановления БД:
При неисправном incremental backup за понедельник мы не сможем восстановить БД за вторник, а получи лишь full backup с ближайших выходных(воскресенья).

Второй вариант.

Например, делать full backup каждый вечер, когда все сотрудники ушли по домам.

Третий вариант и он наиболее подходящий для этой задачи:

- Каждые выходные (воскресенье) у нас будет создаваться полный backup БД. Будем использовать эту копию как начальную точку.
- выбираем делать каждый день differential backup
- при необходимости восстановления БД за предыдущий день (например, четверг):
Сперва восстанавливаем full backup с ближайших выходных(воскресенья), а следом на него накатываем backup за предыдущий день (среду).

1.2.	Необходимо восстанавливать данные за час до предполагаемой поломки.
Выбираю incremental backup.

- Каждые день по вечеру у нас будет создаваться полный backup БД. Будем использовать эту копию как начальную точку.
- Каждый день, с периодичностью создания – каждый час, будем создавать incremental backup.

При необходимости восстановления БД, например, за среду 16:00:

- сначала восстанавливаем full backup за предыдущий день,
- далее на восстановленную БД заливаем поочередно все incremental backup за среду до нужного нам времени.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

Это легко провернуть, используя репликацию БД. Д.б. настроена синхронная репликация на slave-сервер и хорошо бы еще иметь и slave-сервер с асинхронной репликацией. При выходе из строя, master-сервера с работающей БД, slave-сервер c синхронной репликацией перенимает на себя права master-сервера. Когда master-сервер восстановят, он берет на себя главенствующую роль. Также на время поломки master-сервера можно перенастроить slave-сервер с асинхронной репликацией на slave-сервер c синхронной репликацией. Пользователи даже ничего и не заметят, админ лишь вытрет пот со лба, порадовавшись настроенной репликацией.


### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

Ответ:

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

[Cсылка на статью 1](https://postgrespro.ru/docs/postgresql/15/backup-dump)
[Cсылка на статью 2](https://postgrespro.ru/docs/postgresql/15/app-pgrestore)


```
pg_dump имя_базы > файл_дампа		резервирования данных
psql имя_базы < файл_дампа		восстановление БД
где файл_дампа — это файл, содержащий вывод команды pg_dump
```
Дампы, выгруженные не в текстовом формате, восстанавливаются утилитой pg_restore.
```
pg_restore [параметр-подключения...] [параметр...] [имя_файла]
```
Утилита pg_restore предназначена для восстановления базы данных PostgreSQL из архива, созданного командой pg_dump в любом из не текстовых форматов. 

Пример:

Предположим, что мы выгрузили базу данных mydb в файл специального формата:
```
$ pg_dump -Fc mydb > db.dump
```
Мы можем удалить базу данных и восстановить её из копии:
```
$ dropdb mydb
$ pg_restore -C -d postgres db.dump
```
В аргументе -d можно указать любую базу данных, существующую в кластере; pg_restore использует её, только чтобы выполнить команду CREATE DATABASE для базы mydb. С параметром -C данные всегда восстанавливаются в базу, имя которой записано в файле архива.

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

[Cсылка на статью 3](https://selectel.ru/blog/postgresql-backup-tools/)

Резервное копирование обычно выполняется по расписанию, например, ежедневно в 3 часа ночи. Нижеприведенный пример скрипта не только выполняет бэкап, но и удаляет все файлы старше 61 дня (за исключением 15-го числа месяца).

```
#!/bin/sh
PATH=/etc:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin
PGPASSWORD=some_password
export PGPASSWORD
pathB=/mnt/backup
dbUser=dbadmin
database=db
find $pathB \( -name "*-1[^5].*" -o -name "*-[023]?.*" \) -ctime +61 -delete
pg_dump -U $dbUser $database | gzip > $pathB/pgsql_$(date "+%Y-%m-%d").sql.gz
unset PGPASSWORD
```

Чтобы настроить регулярное выполнение, выполним следующую команду в планировщике crontab:

```
# crontab -e
3 0 * * * /etc/scripts/pgsql_dump.sh # postgres pg dump
```
Скрипт будет запускаться каждый день в 03:00.


### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

Ответ:

[Cсылка на статью 4](https://dev.mysql.com/doc/mysql-enterprise-backup/8.0/en/mysqlbackup.incremental.html)
[Cсылка на статью 5](https://serveradmin.ru/polnyj-i-inkrementnyj-backup-mysql/)

```
--incremental-base=history:last_full_backup
```
Или с помощью утилиты XtraBackup.

```
xtrabackup --backup --target-dir=/root/backupdb/inc1 --incremental-basedir=/root/backupdb/full
```

[Cсылка на google docs по «Резервное копирование баз данных»](https://docs.google.com/document/d/18eYRaObSKBVmabgGy6Wv57EEgxHcg70P/edit?usp=sharing&ouid=104113173630640462528&rtpof=true&sd=true)